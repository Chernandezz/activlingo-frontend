<app-onboarding-welcome-overlay *ngIf="showOnboarding" (startFreeTrial)="handleStartFreeTrial()">
</app-onboarding-welcome-overlay>


<div class="flex h-full">
  <!-- Sidebar Desktop -->
  <div class="hidden md:flex w-[25rem] flex-shrink-0 h-full">
    <app-chat-sidebar [chats]="(chats$ | async) ?? []" [currentChatId]="currentChatId"
      [hideAIResponses]="(hideAIResponses$ | async) ?? false" [isCreatingChat]="isCreatingChat" [showModal]="showModal"
      (toggleSidebar)="ui.toggleSidebar()" (select)="handleSelectChat($event)" (startChat)="handleStartNewChat($event)"
      (toggleAI)="ui.toggleHideAIResponses()" (openModal)="openModal()" (closeModal)="closeModal()"
      class="w-full h-full"></app-chat-sidebar>
  </div>

  <!-- Sidebar Mobile -->
  <div *ngIf="isSidebarOpen" class="fixed inset-0 z-50 flex lg:hidden">
    <div class="w-[320px] bg-white shadow-xl">
      <app-chat-sidebar [chats]="(chats$ | async) ?? []" [currentChatId]="currentChatId"
        [hideAIResponses]="(hideAIResponses$ | async) ?? false" [isCreatingChat]="isCreatingChat"
        [showModal]="showModal" (toggleSidebar)="ui.toggleSidebar()" (select)="handleSelectChat($event)"
        (startChat)="handleStartNewChat($event)" (toggleAI)="ui.toggleHideAIResponses()" (openModal)="openModal()"
        (closeModal)="closeModal()"></app-chat-sidebar>
    </div>
    <div class="flex-1 bg-black/20" (click)="ui.closeSidebar()"></div>
  </div>

  <!-- Main Content -->
  <div class="flex-grow flex flex-col h-full overflow-hidden position-relative">
    <!-- Chat Header -->
    <div *ngIf="currentChat$ | async" class="bg-transparent p-4 flex items-center justify-end z-10 pointer-events-none">
      <div
        class="pointer-events-auto flex gap-2 items-center shadow-lg backdrop-blur-md bg-white/80 border border-gray-200 px-4 py-2 rounded-full">
        <button (click)="toggleAnalysisView()"
          class="inline-flex items-center gap-2 text-sm font-semibold px-3 py-1.5 rounded-full border transition"
          [ngClass]="showAnalysis
            ? 'bg-blue-600 text-white border-blue-600'
            : 'bg-green-600 text-white border-green-600 hover:bg-green-700'">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          {{ showAnalysis ? 'Regresar' : 'Analizar Chat' }}
        </button>

        <button (click)="closeCurrentChat()"
          class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition" title="Cerrar chat">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex-grow flex flex-col overflow-hidden">
      <!-- Chat Messages View -->
      <div *ngIf="!showAnalysis && (currentChat$ | async)" class="flex-grow flex flex-col overflow-hidden">
        <div class="flex-grow overflow-y-auto bg-white h-100" #messagesContainer>
          <div *ngIf="(messages$ | async)?.length === 0" class="flex items-center justify-center h-full px-4">
            <div class="text-center max-w-md">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Start your conversation</h3>
              <p class="text-gray-500 text-sm mb-6">
                Begin practicing your English conversation skills. Type a message or use voice recording below.
              </p>
            </div>
          </div>

          <div *ngIf="(messages$ | async)?.length! > 0" class="px-4 py-6 space-y-4 overflow-y-hidden">
            <app-chat-message *ngFor="let message of messages$ | async; trackBy: trackByMessage" [message]="message"
              [hideAIResponses]="(hideAIResponses$ | async) ?? false"></app-chat-message>
          </div>
        </div>

        <!-- OVERLAY -->
        <app-conversation-overlay *ngIf="overlayVisible$ | async" [message]="overlayMessage" [isNaturalMode]="isNaturalMode"
          [tasks]="tasksList" [isRecordingManual]="isRecordingManual" [isProcessing]="isProcessing"
          (close)="endConversationMode()" (toggleMode)="toggleConversationMode()" (sendVoice)="handleAudioRecording($event)"
          (startRecording)="handleManualRecording()">
        </app-conversation-overlay>
      
      

        <!-- Chat Input -->
        <div class="bg-white p-4 flex-shrink-0">
          <app-chat-input [message]="message" [isRecording]="isRecording" [isProcessing]="isProcessing"
            [recordingDuration]="recordingDuration" (messageChange)="message = $event"
            (send)="handleSendMessage(message)" (sendVoice)="handleAudioRecording($event)"
            (openOverlay)="startConversationMode()"></app-chat-input>
        </div>
      </div>

      <!-- Analysis View -->
      <div *ngIf="showAnalysis && chatForAnalysis" class="flex-grow overflow-y-scroll h-100">
        <app-chat-analysis [chatId]="chatForAnalysis.id" class="min-h-full"></app-chat-analysis>
      </div>

      <!-- No Chat Selected -->
      <div *ngIf="!(currentChat$ | async)" class="flex-grow flex items-center justify-center bg-white">
        <div class="text-center max-w-md px-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome to Activlingo</h2>
          <p class="text-gray-500 mb-8 leading-relaxed">
            Select an existing conversation from the sidebar or create a new one to start practicing your English
            conversation skills.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>