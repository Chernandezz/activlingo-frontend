<div class="relative">

  <!-- Recording Overlay -->
  <div *ngIf="isRecording"
    class="absolute -top-16 left-0 right-0 bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-4 shadow-lg z-20 animate-in slide-in-from-bottom-2 duration-300">
    <div class="flex items-center space-x-3">
      <div class="relative">
        <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse"></div>
        <div class="absolute inset-0 w-4 h-4 bg-red-500 rounded-full animate-ping opacity-75"></div>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-900">Recording audio message</p>
        <p class="text-xs text-gray-500">{{ formatDuration(recordingDuration) }}</p>
      </div>
    </div>
  </div>

  <div class="flex">

    <!-- Main Input Container -->
    <div
      class="w-full bg-white border border-gray-200 rounded-2xl shadow-sm focus-within:border-blue-300 focus-within:shadow-md transition-all duration-200">
      <div class="flex items-end p-3 space-x-3">

        <!-- Text Input -->
        <div class="flex-1 relative">
          <textarea [(ngModel)]="message" (keydown)="onKeyDown($event)" placeholder="Escribe tu mensaje..." rows="1"
            class="w-full resize-none border-0 focus:ring-0 focus:outline-none text-gray-900 placeholder-gray-500 bg-transparent max-h-32"
            [disabled]="isRecording || isProcessing" style="min-height: 24px; line-height: 24px;"></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center space-x-2">

          <!-- Conversation Mode -->
          <button (click)="uiService.setConversationMode(!conversationMode)" [class.bg-green-600]="conversationMode"
            [class.text-white]="conversationMode" [class.bg-gray-100]="!conversationMode"
            [class.text-gray-600]="!conversationMode"
            class="p-2.5 rounded-full transition-all duration-200 flex-shrink-0"
            [attr.title]="conversationMode ? 'Detener conversación' : 'Iniciar conversación'">
            <fa-icon [icon]="conversationMode ? faStop : faComments"></fa-icon>
          </button>



          <!-- Voice Recording -->
          <button (click)="toggleRecording()" [disabled]="isProcessing"
            class="relative p-2.5 rounded-full transition-all duration-200 flex-shrink-0"
            [class.bg-red-500]="isRecording" [class.hover:bg-red-600]="isRecording" [class.text-white]="isRecording"
            [class.bg-gray-100]="!isRecording" [class.hover:bg-blue-100]="!isRecording && !isProcessing"
            [class.text-gray-600]="!isRecording" [class.opacity-50]="isProcessing"
            [class.cursor-not-allowed]="isProcessing">
            <fa-icon [icon]="isRecording ? faStop : faMicrophone"></fa-icon>
          </button>

          <!-- Send -->
          <button (click)="sendMessage()" [disabled]="!canSend"
            class="p-2.5 rounded-full transition-all duration-200 flex-shrink-0" [class.bg-blue-600]="canSend"
            [class.hover:bg-blue-700]="canSend" [class.text-white]="canSend" [class.shadow-md]="canSend"
            [class.bg-gray-100]="!canSend" [class.text-gray-400]="!canSend" [class.cursor-not-allowed]="!canSend">
            <fa-icon [icon]="faPaperPlane" class="rotate-90"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Character Counter -->
      <div *ngIf="message.length > 100" class="px-3 pb-2 text-right">
        <span class="text-xs text-gray-400">{{ message.length }}/500</span>
      </div>
    </div>

    <!-- Processing Overlay -->
    <div *ngIf="isProcessing && !isRecording"
      class="absolute inset-0 bg-white bg-opacity-80 rounded-2xl flex items-center justify-center z-10">
      <div class="flex items-center space-x-3">
        <fa-icon [icon]="faSpinner" class="animate-spin text-blue-600 text-lg"></fa-icon>
        <span class="text-sm text-gray-600 font-medium">Processing...</span>
      </div>
    </div>
  </div>
</div>