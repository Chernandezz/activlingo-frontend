<div class="flex flex-col h-full bg-gradient-to-b from-white to-gray-50/50 border-r border-gray-200 shadow-sm">

  <!-- Header mejorado -->
  <div class="flex-shrink-0 p-6 border-b border-gray-200/80 bg-white/50 backdrop-blur-sm">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-3">
        <h3 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
          Conversaciones
        </h3>
      </div>
      <!-- Botón X solo visible en móvil -->
      <button (click)="toggleSidebar.emit()"
        class="md:hidden text-gray-400 hover:text-blue-600 hover:bg-blue-50 focus:outline-none p-2 rounded-lg transition-all duration-200">
        <fa-icon [icon]="faTimes" class="w-5 h-5"></fa-icon>
      </button>
    </div>
  </div>

  <!-- Contenedor principal con scroll mejorado -->
  <div class="flex-1 flex flex-col overflow-hidden">

    <!-- Lista de chats -->
    <div class="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar">
      <div class="p-2">

        <!-- Items de chat compactos -->
        <div *ngFor="let chat of chats; trackBy: trackByChat" (click)="select.emit(chat.id)"
          class="group relative mb-1.5 px-3 py-3 cursor-pointer rounded-xl transition-all duration-200 hover:shadow-md border border-transparent border-b border-b-gray-100/50 last:border-b-0"
          [class]="currentChatId === chat.id 
               ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200 shadow-sm border-b-blue-200/30' 
               : 'hover:bg-white hover:border-gray-200 hover:border-b-gray-200/60'">

          <div class="flex items-center justify-between">
            <!-- Contenido principal en una línea -->
            <div class="flex items-center gap-3 flex-1 min-w-0">
              <!-- Indicador de estado -->
              <div class="w-2 h-2 rounded-full transition-colors flex-shrink-0"
                [class]="currentChatId === chat.id ? 'bg-blue-500' : 'bg-gray-300 group-hover:bg-gray-400'">
              </div>

              <h3 class="text-sm font-semibold text-gray-900 truncate capitalize transition-colors"
                [class.text-blue-700]="currentChatId === chat.id">
                {{ chat.title }}
              </h3>
            </div>

            <!-- Fecha y opciones en línea -->
            <div class="flex items-center gap-2 flex-shrink-0">
              <!-- Fecha -->
              <span class="text-xs font-medium transition-colors" [class]="currentChatId === chat.id 
                      ? 'text-blue-600' 
                      : 'text-gray-400 group-hover:text-gray-600'">
                {{ getRelativeTime(chat.updated_at) }}
              </span>

              <!-- Opciones menu -->
              <div class="relative">
                <button (click)="toggleMenu(chat.id, $event)"
                  class="p-1 rounded-md transition-all duration-200 opacity-0 group-hover:opacity-100"
                  [class]="currentChatId === chat.id ? 'opacity-100 text-blue-600 hover:bg-blue-100' : 'text-gray-400 hover:text-gray-700 hover:bg-gray-100'"
                  title="Opciones">
                  <fa-icon [icon]="faEllipsisVertical" class="w-4 h-4"></fa-icon>
                </button>

                <!-- Dropdown mejorado -->
                <div *ngIf="openMenuId === chat.id"
                  class="absolute right-0 mt-1 w-44 bg-white/95 backdrop-blur-sm border border-gray-200 rounded-xl shadow-lg z-20 overflow-hidden"
                  (click)="$event.stopPropagation()">

                  <button (click)="deleteChat.emit(chat.id); closeMenu()"
                    class="w-full flex items-center px-4 py-3 text-red-600 hover:bg-red-50/80 transition-colors group/item">
                    <fa-icon [icon]="faTrashAlt"
                      class="w-4 h-4 mr-3 group-hover/item:scale-110 transition-transform"></fa-icon>
                    <span class="text-sm font-medium">Eliminar chat</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State mejorado -->
        <div *ngIf="chats.length === 0" class="text-center py-12 px-4">
          <div
            class="w-16 h-16 mx-auto mb-6 bg-gradient-to-r from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center shadow-sm">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Aún no tienes chats</h3>
          <p class="text-sm text-gray-500 mb-6 max-w-xs mx-auto leading-relaxed">
            Crea tu primera conversación para comenzar a practicar inglés
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer mejorado -->
  <div class="flex-shrink-0 border-t border-gray-200/80 bg-white/50 backdrop-blur-sm p-4 space-y-4">

    <!-- Toggle AI mejorado -->
    <div class="flex items-center justify-between p-3 bg-gray-50/50 rounded-xl border border-gray-100">
      <div class="flex items-center gap-3">
        <div
          class="w-8 h-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center shadow-sm">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <span class="text-sm font-medium text-gray-700">Ocultar IA</span>
      </div>

      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" [checked]="hideAIResponses" (change)="toggleAI.emit()" class="sr-only peer">
        <div
          class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-gradient-to-r peer-checked:from-blue-500 peer-checked:to-indigo-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all after:shadow-sm peer-checked:after:shadow-md">
        </div>
      </label>
    </div>

    <!-- Botón nuevo chat mejorado -->
    <button (click)="openModal.emit()" [disabled]="isCreatingChat"
      class="w-full group relative overflow-hidden px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">

      <!-- Efecto de brillo -->
      <div
        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-1000">
      </div>

      <span *ngIf="!isCreatingChat" class="relative flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Nueva Conversación
      </span>

      <span *ngIf="isCreatingChat" class="relative flex items-center justify-center gap-2">
        <fa-icon [icon]="faSpinner" class="animate-spin"></fa-icon>
        Creando...
      </span>
    </button>

    <!-- Modal (permanece igual) -->
    <app-chat-modal *ngIf="showModal" (cancel)="closeModal.emit()" (start)="startChat.emit($event)">
    </app-chat-modal>
  </div>
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #2563eb, #4f46e5);
    border-radius: 20px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(to bottom, #1d4ed8, #4338ca);
  }
</style>